pipeline {
    agent any
    
    stages {
        stage('Clone Repository') {
            steps {
                git url: 'https://github.com/Loufoquee/minik.git', branch: 'master'
            }
        }

        stage('Diagnostics') {
            steps {
                sh 'whoami'
                sh 'pwd'
                sh 'echo "WORKSPACE = ${WORKSPACE}"'
                sh 'ls -la'
            }
        }
        
        stage('Copy Files to Directory') {
            steps {
                sh '''
                    mkdir -p ${WORKSPACE}/a_data
                    # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
                    cp -R . ${WORKSPACE}/a_data/ || true
                    echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ ${WORKSPACE}/a_data"
                    ls -la ${WORKSPACE}/a_data/
                '''
            }
        }        
        
        stage('Check Docker Access') {
            steps {
                script {
                    echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ Docker..."
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ Docker –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º Minikube
                    def dockerAccess = sh(script: 'docker version', returnStatus: true)
                    if (dockerAccess != 0) {
                        error "‚ùå Docker –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω. –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è jenkins –≤ –≥—Ä—É–ø–ø—É docker: sudo usermod -aG docker jenkins && sudo systemctl restart jenkins"
                    } else {
                        echo "‚úÖ Docker –¥–æ—Å—Ç—É–ø–µ–Ω"
                    }
                }
            }
        }
        
        stage('Start Minikube') {
            steps {
                script {
                    echo "üöÄ –ó–∞–ø—É—Å–∫ Minikube —Å –¥—Ä–∞–π–≤–µ—Ä–æ–º Docker..."
                    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–ª–∞—Å—Ç–µ—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
                    sh 'minikube delete || true'
                    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∏ –∂–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                    sh 'minikube start --driver=docker --force'
                    echo "‚úÖ Minikube —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω"
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
                    sh 'minikube status'
                    sh 'kubectl cluster-info'
                    
                    // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
                    sleep time: 30, unit: 'SECONDS'
                }
            }
        }
        
        stage('Build Frontend Image') {
            steps {
                script {
                    echo "üî® –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
                    // –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–±—Ä–∞–Ω—ã –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –≤–æ–∫—Ä—É–≥ ${WORKSPACE}
                    dir("${WORKSPACE}/a_data/mydataapp-master/frontend-app") {
                        // –°–Ω–∞—á–∞–ª–∞ —Å–æ–±–∏—Ä–∞–µ–º –æ–±—ã—á–Ω—ã–º docker build
                        sh 'docker build -t frontend-app_frontend:latest .'
                        // –ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –≤ Minikube
                        sh 'minikube image load frontend-app_frontend:latest'
                    }
                    echo "‚úÖ –û–±—Ä–∞–∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω –∏ –∑–∞–≥—Ä—É–∂–µ–Ω."
                }
            }
        }
        
        stage('Build Backend Image') {
            steps {
                script {
                    echo "üî® –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ –±—ç–∫–µ–Ω–¥–∞..."
                    // –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–±—Ä–∞–Ω—ã –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –≤–æ–∫—Ä—É–≥ ${WORKSPACE}
                    dir("${WORKSPACE}/a_data/mydataapp-master/postgres-java-app") {
                        sh 'docker build -t postgres-java-app_app:latest .'
                        sh 'minikube image load postgres-java-app_app:latest'
                    }
                    echo "‚úÖ –û–±—Ä–∞–∑ –±—ç–∫–µ–Ω–¥–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω –∏ –∑–∞–≥—Ä—É–∂–µ–Ω."
                }
            }
        }
        
        stage('Apply Kubernetes Manifests') {
            steps {
                script {
                    echo "üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ Kubernetes –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤..."
                    // –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–±—Ä–∞–Ω—ã –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –≤–æ–∫—Ä—É–≥ ${WORKSPACE}
                    dir("${WORKSPACE}/a_data/mydataapp-master/k8s") {
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Å–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã
                        sh 'kubectl apply -f .'
                    }
                    echo "‚úÖ –í—Å–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã."
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
                    sh 'kubectl get pods -n mydataapp'
                    sh 'kubectl get services -n mydataapp'
                }
            }
        }
        
        stage('Wait for Pods Ready') {
            steps {
                script {
                    echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø–æ–¥–æ–≤..."
                    // –ñ–¥–µ–º –ø–æ–∫–∞ –≤—Å–µ –ø–æ–¥—ã –±—É–¥—É—Ç –≥–æ—Ç–æ–≤—ã
                    sh '''
                        timeout 300s bash -c \
                        "until kubectl get pods -n mydataapp --no-headers | grep -v Running | grep -v Completed > /dev/null; do \
                            echo '–ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø–æ–¥–æ–≤...'; \
                            kubectl get pods -n mydataapp; \
                            sleep 10; \
                        done"
                    '''
                    echo "‚úÖ –í—Å–µ –ø–æ–¥—ã –≥–æ—Ç–æ–≤—ã"
                }
            }
        }
        
        stage('Start Minikube dashboard') {
            steps {
                script {
                    echo "üîó –ó–∞–ø—É—Å–∫ Minikube dashboard..."
                    // –ó–∞–ø—É—Å–∫–∞–µ–º dashboard –≤ —Ñ–æ–Ω–µ
                    sh 'nohup minikube dashboard --url > /tmp/minikube-dashboard.log 2>&1 &'
                    sleep time: 10, unit: 'SECONDS'
                    
                    // –ü–æ–ª—É—á–∞–µ–º URL dashboard
                    sh 'minikube dashboard --url || true'
                    echo "‚úÖ Minikube dashboard –∑–∞–ø—É—â–µ–Ω"
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ä–≤–∏—Å–∞—Ö
                    sh 'minikube service list -n mydataapp'
                }
            }
        }    
       
    }
    
    post {
        always {
            echo "üìù Pipeline –∑–∞–≤–µ—Ä—à–µ–Ω. –î–µ—Ç–∞–ª–∏ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ª–æ–≥–∞—Ö –≤—ã—à–µ."
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            sh '''
                echo "=== Minikube Status ==="
                minikube status || true
                echo "=== Kubernetes Pods ==="
                kubectl get pods -A || true
                echo "=== Kubernetes Services ==="
                kubectl get services -A || true
            '''
        }
        success {
            echo "üéâ –í—Å–µ —Å—Ç–∞–¥–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
            echo "üìä Dashboard –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∫–æ–º–∞–Ω–¥–µ: minikube dashboard"
            echo "üåê –°–µ—Ä–≤–∏—Å—ã –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ –∫–æ–º–∞–Ω–¥–µ: minikube service list -n mydataapp"
        }
        failure {
            echo "‚ùå Pipeline –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏."
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ª–æ–≥–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            sh '''
                echo "=== Pods Details ==="
                kubectl describe pods -n mydataapp || true
                echo "=== Services Details ==="
                kubectl describe services -n mydataapp || true
            '''
        }
    }
}