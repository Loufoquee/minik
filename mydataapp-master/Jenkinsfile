pipeline {
    agent any
    
    stages {
        stage('Clone Repository') {
            steps {
                git url: 'https://github.com/Loufoquee/minik.git', branch: 'master'
            }
        }

        stage('Diagnostics') {
            steps {
                sh 'whoami'
                sh 'pwd'
                sh 'echo "WORKSPACE = ${WORKSPACE}"'
                sh 'ls -la ${WORKSPACE}/a_data/mydataapp-master/k8s/'
            }
        }
        
        stage('Copy Files to Directory') {
            steps {
                sh '''
                    mkdir -p ${WORKSPACE}/a_data
                    cp -R . ${WORKSPACE}/a_data/ || true
                    echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ ${WORKSPACE}/a_data"
                '''
            }
        }        
        
        stage('Check Docker Access') {
            steps {
                script {
                    echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ Docker..."
                    def dockerAccess = sh(script: 'docker version', returnStatus: true)
                    if (dockerAccess != 0) {
                        error "‚ùå Docker –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω"
                    } else {
                        echo "‚úÖ Docker –¥–æ—Å—Ç—É–ø–µ–Ω"
                    }
                }
            }
        }
        
        stage('Start Minikube') {
            steps {
                script {
                    echo "üöÄ –ó–∞–ø—É—Å–∫ Minikube —Å –¥—Ä–∞–π–≤–µ—Ä–æ–º Docker..."
                    sh 'minikube delete || true'
                    sh 'minikube start --driver=docker --force'
                    echo "‚úÖ Minikube —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω"
                    
                    sleep time: 30, unit: 'SECONDS'
                }
            }
        }
        
        stage('Build Frontend Image') {
            steps {
                script {
                    echo "üî® –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
                    dir("${WORKSPACE}/a_data/mydataapp-master/frontend-app") {
                        sh 'docker build -t frontend-app_frontend:latest .'
                        sh 'minikube image load frontend-app_frontend:latest'
                    }
                    echo "‚úÖ –û–±—Ä–∞–∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω –∏ –∑–∞–≥—Ä—É–∂–µ–Ω."
                }
            }
        }
        
        stage('Build Backend Image') {
            steps {
                script {
                    echo "üî® –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ –±—ç–∫–µ–Ω–¥–∞..."
                    dir("${WORKSPACE}/a_data/mydataapp-master/postgres-java-app") {
                        sh 'docker build -t postgres-java-app_app:latest .'
                        sh 'minikube image load postgres-java-app_app:latest'
                    }
                    echo "‚úÖ –û–±—Ä–∞–∑ –±—ç–∫–µ–Ω–¥–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω –∏ –∑–∞–≥—Ä—É–∂–µ–Ω."
                }
            }
        }
        
        stage('Apply Kubernetes Manifests') {
            steps {
                script {
                    echo "üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ Kubernetes –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤..."
                    dir("${WORKSPACE}/a_data/mydataapp-master/k8s") {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫–∏–µ —Ñ–∞–π–ª—ã –µ—Å—Ç—å –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
                        sh 'ls -la'
                        
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º –±–∞–∑–æ–≤—ã–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã
                        sh '''
                            kubectl apply -f mydataapp-namespace.yaml
                            kubectl apply -f postgres-secret.yaml
                            kubectl apply -f postgres-pvc.yaml
                            kubectl apply -f postgres-deployment.yaml
                        '''
                    }
                    echo "‚úÖ –ë–∞–∑–æ–≤—ã–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã."
                }
            }
        }
        
        stage('Wait for Postgres') {
            steps {
                script {
                    echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ Postgres..."
                    // –ñ–¥–µ–º –ø–æ–∫–∞ Postgres –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
                    sh '''
                        timeout 300s bash -c '
                        while ! kubectl get pod -n mydataapp -l app=postgres -o jsonpath="{.items[0].status.phase}" | grep -q Running; do
                            echo "Postgres –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω..."
                            kubectl get pods -n mydataapp
                            sleep 10
                        done
                        echo "Postgres –∑–∞–ø—É—â–µ–Ω!"
                        '
                    '''
                    
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∂–¥–µ–º –∫–æ–≥–¥–∞ Postgres —Å—Ç–∞–Ω–µ—Ç –≥–æ—Ç–æ–≤ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                    sh '''
                        kubectl wait --for=condition=Ready pod -l app=postgres -n mydataapp --timeout=300s
                    '''
                    echo "‚úÖ Postgres –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ."
                }
            }
        }
        
        stage('Apply Backend and Frontend') {
            steps {
                script {
                    echo "üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –±—ç–∫–µ–Ω–¥–∞ –∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
                    dir("${WORKSPACE}/a_data/mydataapp-master/k8s") {
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã
                        sh '''
                            kubectl apply -f backend-configmap.yaml
                            kubectl apply -f backend-deployment.yaml
                            kubectl apply -f frontend-deployment.yaml
                            kubectl apply -f service.yaml
                            kubectl apply -f mydataapp-ingress.yaml
                        '''
                    }
                    
                    // –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –±—ç–∫–µ–Ω–¥–∞ –∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
                    sh '''
                        timeout 180s bash -c '
                        while ! kubectl get pod -n mydataapp -l app=backend -o jsonpath="{.items[0].status.phase}" 2>/dev/null | grep -q Running; do
                            echo "Backend –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω..."
                            sleep 10
                        done
                        echo "Backend –∑–∞–ø—É—â–µ–Ω!"
                        '
                        
                        timeout 180s bash -c '
                        while ! kubectl get pod -n mydataapp -l app=frontend -o jsonpath="{.items[0].status.phase}" 2>/dev/null | grep -q Running; do
                            echo "Frontend –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω..."
                            sleep 10
                        done
                        echo "Frontend –∑–∞–ø—É—â–µ–Ω!"
                        '
                    '''
                    
                    echo "‚úÖ –ë—ç–∫–µ–Ω–¥ –∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∑–∞–ø—É—â–µ–Ω—ã."
                }
            }
        }
        
        stage('Show Application Status') {
            steps {
                script {
                    echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
                    sh '''
                        echo "=== –í—Å–µ —Ä–µ—Å—É—Ä—Å—ã –≤ namespace mydataapp ==="
                        kubectl get all -n mydataapp
                        echo "=== –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –ø–æ–¥–æ–≤ ==="
                        kubectl describe pods -n mydataapp
                    '''
                }
            }
        }
        
        stage('Start Minikube dashboard') {
            steps {
                script {
                    echo "üîó –ó–∞–ø—É—Å–∫ Minikube dashboard..."
                    sh 'nohup minikube dashboard --url > /tmp/minikube-dashboard.log 2>&1 &'
                    sleep time: 10, unit: 'SECONDS'
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º URL —Å–µ—Ä–≤–∏—Å–æ–≤
                    sh '''
                        echo "=== –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã ==="
                        minikube service list -n mydataapp
                    '''
                    
                    echo "‚úÖ Minikube dashboard –∑–∞–ø—É—â–µ–Ω"
                }
            }
        }    
       
    }
    
    post {
        always {
            echo "üìù Pipeline –∑–∞–≤–µ—Ä—à–µ–Ω."
            sh '''
                echo "=== –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å ==="
                kubectl get all -n mydataapp
                echo "=== –õ–æ–≥–∏ Postgres ==="
                kubectl logs -l app=postgres -n mydataapp --tail=20 || true
                echo "=== –õ–æ–≥–∏ Backend ==="
                kubectl logs -l app=backend -n mydataapp --tail=20 || true
                echo "=== –õ–æ–≥–∏ Frontend ==="
                kubectl logs -l app=frontend -n mydataapp --tail=20 || true
            '''
        }
        success {
            echo "üéâ Pipeline –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
            sh '''
                echo "=== URLs –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ ==="
                minikube service list -n mydataapp
                echo "=== –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: ==="
                echo "minikube service frontend-service -n mydataapp --url"
                echo "minikube service backend-service -n mydataapp --url"
            '''
        }
        failure {
            echo "‚ùå Pipeline –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π."
            sh '''
                echo "=== –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–æ–∫ ==="
                kubectl get events -n mydataapp --sort-by=.lastTimestamp
            '''
        }
    }
}