pipeline {
    agent any
    
    stages {
        stage('Clone Repository') {
            steps {
                git url: 'https://github.com/Loufoquee/minik.git', branch: 'master'
            }
        }

        stage('Diagnostics') {
            steps {
                sh 'whoami'
                sh 'pwd'
                sh 'echo "WORKSPACE = ${WORKSPACE}"'
                sh 'ls -la'
            }
        }
        
        stage('Copy Files to Directory') {
            steps {
                sh '''
                    mkdir -p ${WORKSPACE}/a_data
                    cp -R . ${WORKSPACE}/a_data/ || true
                    echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ ${WORKSPACE}/a_data"
                    ls -la ${WORKSPACE}/a_data/
                '''
            }
        }        
        
        stage('Check Docker Access') {
            steps {
                script {
                    echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ Docker..."
                    def dockerAccess = sh(script: 'docker version', returnStatus: true)
                    if (dockerAccess != 0) {
                        error "‚ùå Docker –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω. –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è jenkins –≤ –≥—Ä—É–ø–ø—É docker: sudo usermod -aG docker jenkins && sudo systemctl restart jenkins"
                    } else {
                        echo "‚úÖ Docker –¥–æ—Å—Ç—É–ø–µ–Ω"
                    }
                }
            }
        }
        
        stage('Start Minikube') {
            steps {
                script {
                    echo "üöÄ –ó–∞–ø—É—Å–∫ Minikube —Å –¥—Ä–∞–π–≤–µ—Ä–æ–º Docker..."
                    sh 'minikube delete || true'
                    sh 'minikube start --driver=docker --force'
                    echo "‚úÖ Minikube —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω"
                    
                    sh 'minikube status'
                    sh 'kubectl cluster-info'
                    
                    sleep time: 30, unit: 'SECONDS'
                }
            }
        }
        
        stage('Build Frontend Image') {
            steps {
                script {
                    echo "üî® –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
                    dir("${WORKSPACE}/a_data/mydataapp-master/frontend-app") {
                        sh 'docker build -t frontend-app_frontend:latest .'
                        sh 'minikube image load frontend-app_frontend:latest'
                    }
                    echo "‚úÖ –û–±—Ä–∞–∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω –∏ –∑–∞–≥—Ä—É–∂–µ–Ω."
                }
            }
        }
        
        stage('Build Backend Image') {
            steps {
                script {
                    echo "üî® –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ –±—ç–∫–µ–Ω–¥–∞..."
                    dir("${WORKSPACE}/a_data/mydataapp-master/postgres-java-app") {
                        sh 'docker build -t postgres-java-app_app:latest .'
                        sh 'minikube image load postgres-java-app_app:latest'
                    }
                    echo "‚úÖ –û–±—Ä–∞–∑ –±—ç–∫–µ–Ω–¥–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω –∏ –∑–∞–≥—Ä—É–∂–µ–Ω."
                }
            }
        }
        
        stage('Apply Kubernetes Manifests') {
            steps {
                script {
                    echo "üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ Kubernetes –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤..."
                    dir("${WORKSPACE}/a_data/mydataapp-master/k8s") {
                        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–º–µ–Ω—è–µ–º namespace –∏ –∂–¥–µ–º –µ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è
                        sh 'kubectl apply -f mydataapp-namespace.yaml'
                        echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è namespace..."
                        sh 'kubectl wait --for=jsonpath=\'{.status.phase}\'=Active namespace/mydataapp --timeout=60s'
                        
                        // –ó–∞—Ç–µ–º –ø—Ä–∏–º–µ–Ω—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
                        sh 'kubectl apply -f postgres-secret.yaml'
                        sh 'kubectl apply -f postgres-pvc.yaml'
                        sh 'kubectl apply -f postgres-deployment.yaml'
                        sh 'kubectl apply -f postgres-service.yaml'
                        
                        // –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Postgres PVC –∏ Pod
                        echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Postgres PVC..."
                        sh 'kubectl wait --for=jsonpath=\'{.status.phase}\'=Bound pvc/postgres-pvc -n mydataapp --timeout=120s'
                        echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ Postgres..."
                        sh 'kubectl wait --for=condition=Ready pod -l app=postgres -n mydataapp --timeout=120s'
                        
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã
                        sh 'kubectl apply -f backend-configmap.yaml'
                        sh 'kubectl apply -f backend-deployment.yaml'
                        sh 'kubectl apply -f backend-service.yaml'
                        sh 'kubectl apply -f frontend-deployment.yaml'
                        sh 'kubectl apply -f frontend-service.yaml'
                        sh 'kubectl apply -f mydataapp-ingress.yaml'
                    }
                    echo "‚úÖ –í—Å–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã."
                }
            }
        }
        
        stage('Wait for Application Ready') {
            steps {
                script {
                    echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
                    // –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö –ø–æ–¥–æ–≤
                    sh '''
                        kubectl wait --for=condition=Ready pod -l app=backend -n mydataapp --timeout=180s
                        kubectl wait --for=condition=Ready pod -l app=frontend -n mydataapp --timeout=180s
                    '''
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
                    sh '''
                        echo "=== Pods Status ==="
                        kubectl get pods -n mydataapp -o wide
                        echo "=== Services Status ==="
                        kubectl get services -n mydataapp
                        echo "=== PVC Status ==="
                        kubectl get pvc -n mydataapp
                        echo "=== Ingress Status ==="
                        kubectl get ingress -n mydataapp
                    '''
                    echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ."
                }
            }
        }
        
        stage('Start Minikube dashboard') {
            steps {
                script {
                    echo "üîó –ó–∞–ø—É—Å–∫ Minikube dashboard..."
                    sh 'nohup minikube dashboard --url > /tmp/minikube-dashboard.log 2>&1 &'
                    sleep time: 10, unit: 'SECONDS'
                    
                    // –ü–æ–ª—É—á–∞–µ–º URL —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    sh '''
                        echo "=== Frontend Service URL ==="
                        minikube service frontend-service -n mydataapp --url || true
                        echo "=== Backend Service URL ==="
                        minikube service backend-service -n mydataapp --url || true
                    '''
                    
                    sh 'minikube dashboard --url || true'
                    echo "‚úÖ Minikube dashboard –∑–∞–ø—É—â–µ–Ω"
                }
            }
        }    
       
    }
    
    post {
        always {
            echo "üìù Pipeline –∑–∞–≤–µ—Ä—à–µ–Ω. –î–µ—Ç–∞–ª–∏ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ª–æ–≥–∞—Ö –≤—ã—à–µ."
            sh '''
                echo "=== Final Minikube Status ==="
                minikube status || true
                echo "=== Final Kubernetes Pods ==="
                kubectl get pods -A || true
                echo "=== Final Kubernetes Services ==="
                kubectl get services -A || true
                echo "=== Pods Logs ==="
                kubectl logs -l app=postgres -n mydataapp --tail=50 || true
                kubectl logs -l app=backend -n mydataapp --tail=50 || true
                kubectl logs -l app=frontend -n mydataapp --tail=50 || true
            '''
        }
        success {
            echo "üéâ –í—Å–µ —Å—Ç–∞–¥–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
            echo "üìä Dashboard –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∫–æ–º–∞–Ω–¥–µ: minikube dashboard"
            echo "üåê –°–µ—Ä–≤–∏—Å—ã –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ –∫–æ–º–∞–Ω–¥–µ: minikube service list -n mydataapp"
        }
        failure {
            echo "‚ùå Pipeline –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏."
            sh '''
                echo "=== Pods Details ==="
                kubectl describe pods -n mydataapp || true
                echo "=== PVC Details ==="
                kubectl describe pvc -n mydataapp || true
                echo "=== Events ==="
                kubectl get events -n mydataapp --sort-by='.lastTimestamp' || true
            '''
        }
    }
}